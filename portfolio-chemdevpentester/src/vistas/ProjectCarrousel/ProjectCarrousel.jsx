import { Box, Typography, Button } from "@mui/material";
import { motion, AnimatePresence } from "framer-motion";
import { useState, useEffect } from "react";

const projects = [
  {
    title: "Mitigaci√≥n del impacto de la calidad de la materia prima y su proceso en el color del az√∫car",
    description: `Este proyecto, desarrollado en colaboraci√≥n con Cenica√±a y la Universidad del Valle, se centr√≥ en analizar y reducir el impacto que tienen las variaciones en la calidad de la ca√±a de az√∫car sobre el color final del producto (az√∫car blanca directa y refinada).`,
    demoLink: "/Documentos/projects/mitigation-raw-material-impact-sugar-color.pdf",
    image: "/ProjectsImages/project1/p0.png",
    backgroundImages: [
      "/ProjectsImages/project1/p2.JPG",
      "/ProjectsImages/project1/p3.JPG",
      "/ProjectsImages/project1/p4.JPG",
      "/ProjectsImages/project1/p5.JPG",
    ],
  },
  {
    title: "Gesti√≥n de los par√°metros operativos de la planta de alcohol sulfatado para la multinacional Unilever.",
    description: `Este proyecto consisti√≥ en la parametrizaci√≥n y puesta en marcha de los procesos en la planta de alcohol sulfatado de la empresa Qu√≠micos del Cauca SAS para producir Lauril √âter Sulfato de Sodio de 1 mol (SLES 1EO). El objetivo principal fue cumplir con las especificaciones t√©cnicas y de calidad exigidas por Unilever para su portafolio de productos de cuidado personal, sustituyendo importaciones por una soluci√≥n de fabricaci√≥n nacional.`,
    demoLink: "/Documentos/projects/unilever-sulphated-alcohol-plant-operational-parameters.pdf",
    image: "/ProjectsImages/project2/p0.jpg",
    backgroundImages: [
      "/ProjectsImages/project2/p1.JPG",
      "/ProjectsImages/project2/p2.JPG",
      "/ProjectsImages/project2/p3.JPG",
    ],
  },
  {
    title: "Evaluaci√≥n de la eficiencia de generadores de vapor mediante los m√©todos directo, indirecto y de exerg√≠a.",
    description: `Este proyecto se desarroll√≥ en la empresa Lloreda S.A. (Yumbo, Valle del Cauca) como respuesta a un incremento en los costos operativos debido al aumento anual del precio del metro c√∫bico de gas natural, que gener√≥ sobrecostos de 15 millones de COP en 2020.`,
    demoLink: "Documentos/projects/steam-generator-efficiency-evaluation.pdf",
    image: "/ProjectsImages/project3/p0.JPG",
    backgroundImages: [
      "/ProjectsImages/project3/p1.JPG",
      "/ProjectsImages/project3/p2.JPG",
      "/ProjectsImages/project3/p3.JPG",
      "/ProjectsImages/project3/p4.JPG",
      "/ProjectsImages/project3/p6.JPG",
    ],
  },
];

export default function ProjectCarrousel() {
  const [current, setCurrent] = useState(0); 
  const [bgIndex, setBgIndex] = useState(0); 

  // Auto cambio de fondo + cambio de proyecto
  useEffect(() => {
    const interval = setInterval(() => {
      setBgIndex((prev) => {
        const total = projects[current].backgroundImages.length;

        if (prev + 1 >= total) {
          // Ya se recorrieron todas las im√°genes de fondo
          setCurrent((cPrev) => (cPrev + 1) % projects.length);
          return 0; // reiniciar fondos para el nuevo proyecto
        }

        return prev + 1; // avanzar fondo
      });
    }, 2000); // velocidad de cambio de fondo
    return () => clearInterval(interval);
  }, [current]);

  const handlePrev = () =>
    setCurrent((prev) => (prev - 1 + projects.length) % projects.length);
  const handleNext = () => setCurrent((prev) => (prev + 1) % projects.length);

  const handleDownload = (fileUrl, fileName) => {
    const link = document.createElement("a");
    link.href = fileUrl;
    link.download = fileName || "documento.pdf";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };
  

  return (
    <Box
      id="proyectos"
      sx={{
        width: "100%",
        height: "100vh",
        overflow: "hidden",
        position: "relative",
      }}
    >
      <AnimatePresence initial={false}>
        {projects.map((p, i) =>
          i === current ? (
            <motion.div
              key={i}
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.4 }}
              style={{
                position: "absolute",
                width: "100%",
                height: "100%",
              }}
            >
              {/* Imagen de fondo con slideshow */}
              <AnimatePresence mode="wait">
                <motion.img
                  key={p.backgroundImages[bgIndex]}
                  src={p.backgroundImages[bgIndex]}
                  alt={p.title}
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  transition={{ duration: 0.5 }}
                  style={{
                    width: "100%",
                    height: "100%",
                    objectFit: "cover",
                    filter: "brightness(0.55)",
                    position: "absolute",
                    top: 0,
                    left: 0,
                  }}
                />
              </AnimatePresence>

              {/* Contenedor central */}
              <Box
              sx={{
                position: "absolute",
                top: "50%",
                left: "50%",
                transform: "translate(-50%, -50%)",
                width: "90%",
                height: "85%",
                display: "flex",
                flexDirection: { xs: "column", md: "row" },
                alignItems: "center",
                justifyContent: "center",
                gap: "2rem",
                color: "white",
              }}
              >
                {/* Imagen del proyecto */}
                <Box
                  component="img"
                  src={p.image}
                  alt={p.title}
                  sx={{
                    flex: 1,
                    mt: {
                      xs: 5.5,   // üì± m√≥viles
                      sm: 3,   // üì≤ m√≥viles grandes / tablets chicas
                      md: 0,   // üíª desktop
                    },
                    maxWidth: {
                      xs: "90%", // xtra small
                      sm: "90%", // small
                      md: "50%",// medium
                    },      
                    maxHeight: {
                      xs: "210px", 
                      sm: "300px",
                      md: "none",
                    },
                    borderRadius: "16px",
                    objectFit: "cover",
                    boxShadow: "0 10px 40px rgba(0,0,0,0.6)",
                  }}
                />

                {/* Texto */}
                <Box
                  sx={{
                    flex: 1,
                    px: { xs: 0, md: 4 },
                    textAlign: { xs: "center", md: "left" },
                  }}
                >
                  <Typography
                    variant="h3"
                    sx={{
                      fontWeight: "bold",
                      mt: { xs: 2, md: 1, lg: 1.4, xl: 0 },
                      mb: 3,
                      fontSize: { xs: "clamp(1.4rem, 3vw, 3rem)", xl: "2.4rem",md: "1.72rem", lg: "1.75rem" },
                      lineHeight: 1.2,
                      wordBreak: "break-word",
                    }}
                  >
                    {p.title}
                  </Typography>
                  <Typography
                    variant="h6"
                    sx={{
                      color: "#ccc",
                      mb: 4,
                      fontSize: { xs: "clamp(0.95rem, 1.2vw, 1.15rem)", xl: "1.4rem",md: "1.1rem", lg: "1.2rem" },
                      lineHeight: 1.7,
                      textAlign: "justify",
                      textJustify: "inter-word",
                      hyphens: "auto",
                      wordBreak: "break-word",
                    }}
                  >
                    {p.description}
                  </Typography>
                  <Button
                    variant="contained"
                    onClick={() =>
                      handleDownload(
                        p.demoLink,
                        p.demoLink.split("/").pop()
                      )
                    }         
                    color="primary"
                    target="_blank"
                    sx={{ px: 4, py: 1.5 }}
                  >
                    Descargar Documento
                  </Button>
                </Box>
              </Box>

              {/* Botones de navegaci√≥n */}
              <Box
                onClick={handlePrev}
                sx={{
                  position: "absolute",
                  top: 0,
                  left: 0,
                  height: "100%",
                  width: { xs: "50px", md: "70px" },
                  background: "rgba(0,0,0,0.05)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: "pointer",
                  "&:hover": {
                    background: "rgba(0,0,0,0.2)",
                  },
                  zIndex: 5,
                }}
              >
                <Typography
                  component="span"
                  sx={{ color: "rgba(255,255,255,0.4)", fontSize: "2rem" }}
                >
                  ‚ùÆ
                </Typography>
              </Box>

              <Box
                onClick={handleNext}
                sx={{
                  position: "absolute",
                  top: 0,
                  right: 0,
                  height: "100%",
                  width: { xs: "50px", md: "70px" },
                  background: "rgba(0,0,0,0.05)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: "pointer",
                  "&:hover": {
                    background: "rgba(0,0,0,0.2)",
                  },
                  zIndex: 5,
                }}
              >
                <Typography
                  component="span"
                  sx={{ color: "rgba(255,255,255,0.4)", fontSize: "2rem" }}
                >
                  ‚ùØ
                </Typography>
              </Box>
            </motion.div>
          ) : null
        )}
      </AnimatePresence>
    </Box>
  );
}
