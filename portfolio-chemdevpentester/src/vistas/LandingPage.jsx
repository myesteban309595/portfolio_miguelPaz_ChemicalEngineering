import {
  AppBar,
  Toolbar,
  Typography,
  Button,
  Container,
  Box,
  Divider,
  Grid,
} from "@mui/material";
import { createTheme, ThemeProvider } from "@mui/material/styles";
import { motion } from "framer-motion";
import { useEffect, useState, useRef } from "react";
import { Link } from "react-scroll";

import ProjectCarrousel from "./ProjectCarrousel/ProjectCarrousel";

import HCVModal from "../Modals/HCVModal";
import ThankYouModal from "../Modals/ThankYouModal";

const logos = [
  { src: "/logos/liderazgo.png", name: "Liderazgo", width: 70, height: 70 },
  {
    src: "/logos/trabajoenequipo.png",
    name: "Trabajo en Equipo",
    width: 90,
    height: 60,
  },
  {
    src: "/logos/manejopersonal.png",
    name: "Manejo de Personal",
    width: 200,
    height: 130,
  },
  {
    src: "/logos/adaptabilidad.png",
    name: "Adaptabilidad",
    width: 95,
    height: 95,
  },
  {
    src: "/logos/optimizacion.png",
    name: "Optimizaci√≥n",
    width: 90,
    height: 90,
  },
  { src: "/logos/eficiencia.png", name: "Eficiencia", width: 80, height: 80 },
  { src: "/logos/proactivo.png", name: "Proactivo", width: 80, height: 80 },
  { src: "/logos/dinamico.png", name: "Din√°mico", width: 80, height: 80 },
];

const EngineerLogos = [
  {
    src: "/logos/MicrosoftExcel.png",
    name: "Excel Avanzado",
    width: 120,
    height: 80,
  },
  {
    src: "/logos/ms-word.png",
    name: "Microsoft Word",
    width: 140,
    height: 80,
  },
  {
    src: "/logos/Ofimatica.png",
    name: "Herramientas Ofimaticas",
    width: 80,
    height: 80,
  },
  { src: "/logos/Power-BI.png", name: "Power BI + IA", width: 92, height: 92 },
  {
    src: "/logos/sap.webp",
    name: "SAP B.One S/4Hana",
    width: 90,
    height: 90,
  },
  { src: "/logos/HYSYS.png", name: "Aspen Hysys", width: 80, height: 80 },
  {
    src: "/logos/sixsigma_black.png",
    name: "Lean Six Sigma Black Belt",
    width: 85,
    height: 85,
  },
  {
    src: "/logos/sixsigma.png",
    name: "Lean Six Sigma Yellow Belt",
    width: 120,
    height: 75,
  },
];

// üîπ Typing Effect para Hero
const TypingEffect = ({ texts, speed = 40 }) => {
  const [displayedText, setDisplayedText] = useState("");
  const [index, setIndex] = useState(0);
  const [textIndex, setTextIndex] = useState(0);

  useEffect(() => {
    if (index < texts[textIndex].length) {
      const timeout = setTimeout(() => {
        setDisplayedText((prev) => prev + texts[textIndex][index]);
        setIndex(index + 1);
      }, speed);
      return () => clearTimeout(timeout);
    } else {
      setTimeout(() => {
        setDisplayedText("");
        setIndex(0);
        setTextIndex((prev) => (prev + 1) % texts.length);
      }, 800);
    }
  }, [index, textIndex, texts, speed]);

  return (
    <Typography
      variant="h5"
      sx={{ mt: 2, color: "#00e5ff", fontWeight: "bold" }}
    >
      {displayedText}
      {/* <span className="blinking-cursor">|</span> */}
    </Typography>
  );
};

// üîπ Tema Oscuro
const darkTheme = createTheme({
  palette: {
    mode: "dark",
    primary: { main: "#00e5ff" },
    background: { default: "#0a0a0a", paper: "rgba(18,18,18,0.7)" },
  },
  typography: {
    fontFamily: "'Poppins', sans-serif",
  },
});

// üîπ Landing Page
export default function LandingPage() {
  const sectionsRef = useRef({});
  const [active, setActive] = useState("hero");
  const [skillsIndex, setSkillsIndex] = useState(0);

  const [modalOpen, setModalOpen] = useState(false);
  const [thankYouOpen, setThankYouOpen] = useState(false);

  useEffect(() => {
    const interval = setInterval(() => {
      setSkillsIndex((prev) => (prev === 0 ? 1 : 0));
    }, 4500);

    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            setActive(entry.target.id);
          }
        });
      },
      {
        root: document.getElementById("scroll-container"),
        threshold: 0.6,
      }
    );

    Object.values(sectionsRef.current).forEach((section) => {
      if (section) observer.observe(section);
    });

    return () => observer.disconnect();
  }, []);

  // envio de correo
  const enviarFormularioContacto = async (e) => {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    // Configuraci√≥n FormSubmit
    formData.append("_subject", "Tienes un mensaje desde el portafolio üöÄ");
    formData.append("_captcha", "false");
    formData.append("_template", "table");

    try {
      const response = await fetch(
        "https://formsubmit.co/ajax/017251fa4037517c5787d1a815a79c74",
        {
          method: "POST",
          body: formData,
        }
      );

      if (response.ok) {
        setThankYouOpen(true);
        alert("Mensaje enviado correctamente üöÄ");
        form.reset();
      } else {
        alert("Error al enviar el mensaje ‚ùå");
      }
    } catch (error) {
      alert("Error de conexi√≥n ‚ùå");
    }
  };

  return (
    <ThemeProvider theme={darkTheme}>
      <Box
        id="scroll-container"
        sx={{
          height: "100vh",
          overflowY: "auto",
          scrollSnapType: "y mandatory",
          scrollBehavior: "smooth",
        }}
      >
        {/* Navbar flotante */}
        <AppBar
          position="sticky"
          sx={{
            top: 0,
            left: 0,
            right: 0,
            background: "rgba(0,0,0,0.5)",
            backdropFilter: "blur(8px)",
            boxShadow: "none",
            zIndex: 1200,
          }}
        >
          <Toolbar>
            <Typography variant="h6" sx={{ flexGrow: 1, fontWeight: "bold" }}>
              Miguel Paz | Energy Efiiciency Specialist
            </Typography>

            {[
              { label: "Hero", id: "hero" },
              { label: "Sobre m√≠", id: "sobremi" },
              { label: "Proyectos", id: "proyectos" },
              { label: "Contacto", id: "contacto" },
            ].map((item, i) => (
              <Button
                key={i}
                component={Link}
                containerId="scroll-container"
                to={item.id}
                smooth={true}
                duration={20}
                offset={0}
                onClick={() => setActive(item.id)}
                className={active === item.id ? "active" : ""}
                color="inherit"
                sx={{
                  position: "relative",
                  textTransform: "none",
                  mx: 1,
                  "&.active": {
                    color: "#00e5ff",
                    fontWeight: "bold",
                    textShadow: "0 0 8px #00e5ff, 0 0 16px #00bfa6",
                  },
                  "&.active::after": {
                    content: '""',
                    position: "absolute",
                    bottom: -6,
                    left: "50%",
                    transform: "translateX(-50%)",
                    width: "60%",
                    height: "3px",
                    borderRadius: "2px",
                    background: "linear-gradient(90deg, #00e5ff, #00bfa6)",
                    boxShadow: "0 0 8px #00e5ff",
                    animation: "glow 1.5s infinite alternate",
                  },
                  "@keyframes glow": {
                    from: { boxShadow: "0 0 4px #00e5ff" },
                    to: { boxShadow: "0 0 12px #00bfa6" },
                  },
                }}
              >
                {item.label}
              </Button>
            ))}
          </Toolbar>
        </AppBar>

        {/* ===== HERO ===== */}
        <Box
          id="hero"
          ref={(el) => (sectionsRef.current.hero = el)}
          sx={{
            minHeight: "100vh",
            height: "100vh",
            scrollSnapAlign: "start",
            scrollMarginTop: "64px",
            py: 0,
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            textAlign: "center",
            px: { xs: 2, md: 0 },
            background:
              "radial-gradient(circle at top, #0f2027, #203a43, #2c5364)",
            position: "relative",
            overflow: "hidden",
          }}
        >
          {/* columna izquierda */}
          <Box
            sx={{
              flex: "0 0 55%",
              maxWidth: "55%",
              py: 9,
              px: 4,
              background: "linear-gradient(180deg, #0f2027, #203a43, #2c5364)",
              height: "100%",
            }}
          >
            <Typography
              variant="h4"
              align="center"
              gutterBottom
              sx={{ color: "#fff", fontWeight: "bold", mb: 5 }}
            >
              üöÄ Skills & Technologies
            </Typography>

            <motion.div
              key={skillsIndex}
              initial={{ opacity: 0, x: 40 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -40 }}
              transition={{ duration: 0.6 }}
            >
              {skillsIndex === 0 ? (
                <>
                  {/* ================= SOFTWARE DEVELOPMENT SKILLS ================= */}
                  <Divider
                    sx={{
                      my: 3,
                      borderColor: "rgba(255,255,255,0.2)",
                      width: "90%",
                      mx: "auto",
                    }}
                  >
                    <Typography
                      sx={{
                        color: "#00e5ff",
                        px: 1,
                        fontWeight: "bold",
                        letterSpacing: 1,
                      }}
                    >
                      Soft Skills
                    </Typography>
                  </Divider>

                  <Grid container spacing={4} justifyContent="center">
                    {logos.map((logo, i) => (
                      <Grid item xs={6} sm={4} md={3} key={i}>
                        <Box
                          sx={{
                            display: "flex",
                            flexDirection: "column",
                            alignItems: "center",
                            width: "100%",
                          }}
                        >
                          <Box
                            sx={{
                              width: { xs: 90, sm: 100, md: 100 },
                              height: { xs: 90, sm: 100, md: 100 },
                              borderRadius: "16px",
                              background: "rgba(255,255,255,0.05)",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              p: { xs: 1, sm: 1.5, md: 2 },
                            }}
                          >
                            <motion.img
                              src={logo.src}
                              alt={logo.name}
                              style={{
                                maxWidth: "100%",
                                maxHeight: "100%",
                                width: "auto",
                                height: "auto",
                                objectFit: "contain",
                              }}
                              whileHover={{
                                scale: 1.2,
                                rotate: 5,
                                filter: "drop-shadow(0px 0px 20px #00e5ff)",
                              }}
                              transition={{ type: "spring", stiffness: 300 }}
                            />
                          </Box>

                          <Typography
                            variant="body1"
                            sx={{
                              color: "#fff",
                              mt: 1,
                              textAlign: "center",
                              fontSize: {
                                xs: "0.75rem",
                                sm: "0.8rem",
                                md: "0.8rem",
                              },
                              lineHeight: 1.2,
                            }}
                          >
                            {logo.name}
                          </Typography>
                        </Box>
                      </Grid>
                    ))}
                  </Grid>
                </>
              ) : (
                <>
                  {/* ================= TECHNICAL ENGINEERING SKILLS ================= */}
                  <Divider
                    sx={{
                      my: 4,
                      borderColor: "rgba(255,255,255,0.2)",
                      width: "90%",
                      mx: "auto",
                    }}
                  >
                    <Typography
                      sx={{
                        color: "#00e5ff",
                        px: 2,
                        fontWeight: "bold",
                        letterSpacing: 1,
                      }}
                    >
                      Tecnical Engineering Skills
                    </Typography>
                  </Divider>

                  <Grid container spacing={4} justifyContent="center">
                    {EngineerLogos.map((logo, i) => (
                      <Grid item xs={6} sm={4} md={3} key={i}>
                        <Box
                          sx={{
                            display: "flex",
                            flexDirection: "column",
                            alignItems: "center",
                          }}
                        >
                          <Box
                            sx={{
                              width: { xs: 90, sm: 100, md: 90 },
                              height: { xs: 90, sm: 100, md: 90 },
                              borderRadius: "16px",
                              background: "rgba(255,255,255,0.05)",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              p: { xs: 1, sm: 1.5, md: 2 },
                            }}
                          >
                            <motion.img
                              src={logo.src}
                              alt={logo.name}
                              style={{
                                maxWidth: "100%",
                                maxHeight: "100%",
                                width: "auto",
                                height: "auto",
                                objectFit: "contain",
                              }}
                              whileHover={{
                                scale: 1.2,
                                rotate: 5,
                                filter: "drop-shadow(0px 0px 20px #00e5ff)",
                              }}
                              transition={{ type: "spring", stiffness: 300 }}
                            />
                          </Box>

                          <Typography
                            variant="body1"
                            sx={{
                              color: "#fff",
                              mt: 1,
                              textAlign: "center",
                              fontSize: {
                                xs: "0.75rem",
                                sm: "0.8rem",
                                md: "0.8rem",
                              },
                              lineHeight: 1.2,
                            }}
                          >
                            {logo.name}
                          </Typography>
                        </Box>
                      </Grid>
                    ))}
                  </Grid>
                </>
              )}
            </motion.div>
          </Box>

          {/* columna derecha */}
          <Container
            sx={{
              flex: "0 0 45%",
              maxWidth: "45%",
              position: "relative",
              zIndex: 2,
            }}
          >
            <motion.div
              initial={{ opacity: 0, y: 60 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 1 }}
            >
              <Typography
                variant="h4"
                sx={{ fontWeight: "bold", color: "white" }}
              >
                Hola, soy <span style={{ color: "#00e5ff" }}>[Miguel Paz]</span>
              </Typography>

              <TypingEffect
                texts={[
                  "Chemical Engineer",
                  "Energy Efficiency Specialist",
                  "QEHS and Energy Internal Auditor",
                ]}
              />

              <Link
                to="contacto"
                containerId="scroll-container"
                smooth={true}
                duration={800}
                offset={0}
              >
                <Button
                  variant="contained"
                  color="primary"
                  sx={{
                    mt: 8,
                    px: 4,
                    py: 1.5,
                    borderRadius: "12px",
                    fontWeight: "bold",
                  }}
                >
                  Cont√°ctame
                </Button>
              </Link>
            </motion.div>
          </Container>
        </Box>

        {/* ===== ABOUT ===== */}
        <Box
          id="sobremi"
          ref={(el) => (sectionsRef.current.sobremi = el)}
          sx={{
            width: "100%",
            height: "100vh",
            scrollSnapAlign: "start",
            // scrollMarginTop: "64px",
            minHeight: "100vh",
            px: { xs: 2, md: 4 },
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            bgcolor: "background.paper",
            overflow: "hidden",
          }}
        >
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 1 }}
            style={{
              display: "flex",
              flexDirection: "row",
              alignItems: "center",
              gap: "4rem",
              width: "100%",
              maxWidth: "1200px",
            }}
          >
            <Box
              sx={{
                position: "relative",
                width: { xs: "80vw", md: "28vw" },
              }}
            >
              {/* Imagen */}
              <Box
                component="img"
                src="/Foto/fotopersonal1.png"
                alt="Marlon Esteban"
                sx={{
                  width: "100%",
                  height: "auto",
                  borderRadius: "16px",
                  boxShadow: "0 8px 40px rgba(0,0,0,0.7)",
                  objectFit: "cover",
                }}
              />

              {/* Bot√≥n Ver m√°s */}
              <motion.div
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 5, duration: 0.6 }}
                style={{
                  position: "absolute",
                  top: 20,
                  right: 15,
                }}
              >
                <Button
                  variant="outlined"
                  onClick={() => setModalOpen(true)}
                  sx={{
                    position: "relative",
                    overflow: "hidden",
                    color: "#00e5ff",
                    borderColor: "transparent",
                    fontWeight: "bold",
                    fontSize: 11,
                    borderRadius: "12px",
                    px: 2.0,
                    py: 0.6,
                    backdropFilter: "blur(6px)",
                    background: "rgba(0,0,0,0.45)",
                    textShadow: "0 0 8px rgba(0,229,255,0.9)",

                    /* === FONDO NEON === */
                    "&::after": {
                      content: '""',
                      position: "absolute",
                      inset: "-40%",
                      background:
                        "radial-gradient(circle at center, rgba(0,229,255,0.35), transparent 70%)",
                      filter: "blur(22px)",
                      opacity: 0.9,
                      zIndex: -1,
                      transition: "0.4s ease",
                    },

                    /* Neon base */
                    boxShadow:
                      "0 0 7px rgba(0,229,255,0.6), 0 0 28px rgba(0,229,255,0.35)",

                    /* === BORDE ANIMADO === */
                    "&::before": {
                      content: '""',
                      position: "absolute",
                      inset: 0,
                      borderRadius: "12px",
                      border: "2px solid #00e5ff",
                      boxShadow: "0 0 12px rgba(0,229,255,0.8)",
                      transform: "scaleX(0)",
                      transformOrigin: "left",
                      animation: "drawBorder 0.9s ease forwards",
                      animationDelay: "5s",
                    },

                    "&:hover": {
                      color: "#74eada",
                      textShadow: "0 0 10px rgba(0,191,166,1)",
                      boxShadow:
                        "0 0 10px rgba(0,229,255,0.9), 0 0 36px rgba(0, 159, 191, 0.7)",
                      transform: "scale(1.08)",

                      "&::after": {
                        opacity: 1,
                        filter: "blur(26px)",
                      },
                    },

                    "@keyframes drawBorder": {
                      from: { transform: "scaleX(0)" },
                      to: { transform: "scaleX(1)" },
                    },
                  }}
                >
                  M√†s detalles
                </Button>
              </motion.div>
            </Box>

            <Box sx={{ flex: 1, mt: 4 }}>
              <Typography
                variant="h4"
                gutterBottom
                sx={{ fontWeight: "bold", color: "white" }}
              >
                Sobre m√≠
              </Typography>

              <Typography
                variant="body1"
                sx={{
                  color: "#ccc",
                  fontSize: { xs: "1rem", md: "0.99rem" },
                  lineHeight: 1.7,
                  textAlign: "justify",
                }}
              >
                Ingeniero Qu√≠mico con 7 a√±os de experiencia en los sectores de
                cuidado personal, cosm√©ticos, alimentos y farmac√©utico, con
                s√≥lidos conocimientos en optimizaci√≥n, control y mejora de
                procesos a nivel industrial. Especialista en la transformaci√≥n
                de materias primas para generar valor agregado y en el an√°lisis
                de muestras qu√≠micas bajo est√°ndares de calidad.
                <br />
                <br />
                Cuento con habilidades destacadas en trabajo en equipo, liderazgo y
                comunicaci√≥n efectiva, orientadas al logro de objetivos
                organizacionales y a la alineaci√≥n de metas estrat√©gicas.
                Interesado en desempe√±arme en √°reas de mejoramiento industrial,
                innovaci√≥n, seguridad e higiene, as√≠ como en la automatizaci√≥n
                de procesos y el desarrollo de soluciones sostenibles,
                ambientalmente responsables y centradas en el talento humano.
                <br />
                <br />
              </Typography>
            </Box>
          </motion.div>
        </Box>

        {/* Projects */}
        <Box
          id="proyectos"
          ref={(el) => (sectionsRef.current.proyectos = el)}
          sx={{
            minHeight: "100vh",
            scrollSnapAlign: "start",
            scrollMarginTop: "24px",
          }}
        >
          <ProjectCarrousel />
        </Box>

        {/* Contact (ORIGINAL SIN CAMBIOS) */}
        <Box
          id="contacto"
          ref={(el) => (sectionsRef.current.contacto = el)}
          sx={{
            minHeight: "100vh",
            scrollSnapAlign: "start",
            scrollMarginTop: "24px",
            py: 10,
            px: { xs: 2, md: 4 },
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
            background:
              "linear-gradient(135deg, rgba(0,229,255,0.1), rgba(0,0,0,0.7))",
            backdropFilter: "blur(12px)",
          }}
        >
          <motion.div
            initial={{ opacity: 0, y: 90 }}
            whileInView={{ opacity: 1, y: 0 }}
            transition={{ duration: 1 }}
            style={{
              width: "100%",
              maxWidth: "700px",
              padding: "2.5rem",
              borderRadius: "20px",
              background: "rgba(18,18,18,0.85)",
              boxShadow: "0 8px 40px rgba(0,0,0,0.6)",
            }}
          >
            <Typography
              variant="h4"
              gutterBottom
              sx={{ fontWeight: "bold", color: "#00e5ff", textAlign: "center" }}
            >
              ¬°Hablemos!
            </Typography>

            <Typography
              variant="body1"
              sx={{ color: "#ccc", mb: 1, textAlign: "center" }}
            >
              D√©jame un mensaje y te responder√© lo m√°s pronto posible üöÄ
            </Typography>

            {/* Formulario */}
            <Box
              component="form"
              onSubmit={enviarFormularioContacto}
              sx={{
                display: "flex",
                flexDirection: "column",
                gap: 3,
              }}
            >
              <input
                type="text"
                name="name"
                placeholder="Dime tu nombre"
                style={{
                  padding: "14px",
                  borderRadius: "10px",
                  border: "1px solid #444",
                  background: "#111",
                  color: "white",
                  fontSize: "1rem",
                }}
              />
              <input
                type="email"
                name="email"
                placeholder="Tu correo"
                style={{
                  padding: "14px",
                  borderRadius: "10px",
                  border: "1px solid #444",
                  background: "#111",
                  color: "white",
                  fontSize: "1rem",
                }}
              />
              <textarea
                name="message"
                placeholder="Tu mensaje"
                rows="5"
                style={{
                  padding: "14px",
                  borderRadius: "10px",
                  border: "1px solid #444",
                  background: "#111",
                  color: "white",
                  fontSize: "1rem",
                  resize: "none",
                }}
              />
              <Button
                type="submit"
                variant="contained"
                sx={{
                  background: "linear-gradient(90deg, #00e5ff, #00bfa6)",
                  fontWeight: "bold",
                  py: 1.5,
                  borderRadius: "12px",
                  "&:hover": {
                    background: "linear-gradient(90deg, #00bfa6, #00e5ff)",
                    transform: "scale(1.05)",
                    transition: "0.3s",
                  },
                }}
              >
                Enviar Mensaje
              </Button>
            </Box>
          </motion.div>

          {/* MODALES */}
          <HCVModal open={modalOpen} onClose={() => setModalOpen(false)} />
          {/* MODAL mensaje de agradecimiento*/}
          <ThankYouModal
            open={thankYouOpen}
            onClose={() => setThankYouOpen(false)}
          />
        </Box>
      </Box>
    </ThemeProvider>
  );
}
