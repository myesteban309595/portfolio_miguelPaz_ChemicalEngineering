import { useState, useEffect } from "react";
import MatrixBackground from "./MatrixBackground";
import FondoHomeImage from "./FondoHomeImage";
import { supabase } from "../DB/supabaseClient";

const backgrounds = [MatrixBackground, FondoHomeImage];

function BackgroundManager() {
  const [index, setIndex] = useState(1);
  const [views, setViews] = useState(0);

  // ðŸ”¹ Cambiar fondo al hacer click
  const handleClick = () => {
    setIndex((prev) => (prev + 1) % backgrounds.length);
  };

  useEffect(() => {
    window.addEventListener("click", handleClick);
    return () => window.removeEventListener("click", handleClick);
  }, []);

  // ðŸ”¹ Contador de vistas al montar el componente
  useEffect(() => {
    const alreadyCounted = sessionStorage.getItem("viewCounted");
  
    if (alreadyCounted) return;
    const countView = async () => {
      try {
        const { error: rpcError } = await supabase.rpc("increment_views");
        if (rpcError) throw rpcError;
  
        const { data, error } = await supabase
          .from("views")
          .select("count")
          .eq("id", 1)
          .single();
        if (error) throw error;
  
        setViews(data.count);
        sessionStorage.setItem("viewCounted", "true");
      } catch (err) {
        console.error("Error al contar la vista:", err);
      }
    };
    countView();
  }, []);
  

  const ActiveBackground = backgrounds[index];

  return (
    <>
      <ActiveBackground />
    </>
  );
}

export default BackgroundManager;
