import React, { useState, useEffect } from 'react';
import { Box, Dialog, IconButton, Typography } from '@mui/material';
import CloseIcon from '@mui/icons-material/Close';
import ArrowBackIosNewIcon from '@mui/icons-material/ArrowBackIosNew';
import ArrowForwardIosIcon from '@mui/icons-material/ArrowForwardIos';
import { motion, AnimatePresence } from 'framer-motion';

const ProjectGalleryModal = ({ open, onClose, project }) => {
    const [currentIndex, setCurrentIndex] = useState(0);

    console.log("project que llega:", project);

    useEffect(() => {
        if (open) setCurrentIndex(0);
    }, [open, project]);

    // Si no hay proyecto o imágenes, no renderizar nada
    if (!project || !project.images || project.images.length === 0) return null;

    const handleNext = (e) => {
        e.stopPropagation();
        setCurrentIndex((prev) => (prev + 1) % project.images.length);
    };

    const handlePrev = (e) => {
        e.stopPropagation();
        setCurrentIndex((prev) => (prev - 1 + project.images.length) % project.images.length);
    };

    // Función para normalizar la ruta de la imagen
    const getImagePath = (path) => {
        if (!path) return "";
        // Si la ruta no empieza con http o con /, le agregamos el / para que apunte a public
        if (path.startsWith('http')) return path;
        return path.startsWith('/') ? path : `/${path}`;
    };

    return (
        <Dialog
            open={open}
            onClose={onClose}
            maxWidth="md"
            fullWidth
            PaperProps={{
                sx: {
                    bgcolor: '#0a0a0a',
                    backgroundImage: 'none',
                    borderRadius: 4,
                    overflow: 'hidden',
                    border: '1px solid rgba(0, 229, 255, 0.2)'
                }
            }}
        >
            <Box sx={{ position: 'relative', bgcolor: '#0a0a0a', p: 3, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>

                {/* Header */}
                {/* Header del Modal */}
                <Box
                    sx={{
                        width: '100%',
                        display: 'flex',
                        justifyContent: 'center', // Centra el contenido horizontalmente
                        alignItems: 'center',
                        mb: 3,
                        position: 'relative', // Necesario para que el botón absolute se posicione respecto a este Box
                        minHeight: '40px'     // Asegura un alto mínimo por si el título es corto
                    }}
                >
                    <Typography
                        variant="h6"
                        sx={{
                            color: '#00e5ff',
                            fontWeight: 'bold',
                            textAlign: 'center',
                            px: 5 // Padding lateral para que el texto no choque con el botón en pantallas pequeñas
                        }}
                    >
                        {project.title}
                    </Typography>

                    <IconButton
                        onClick={onClose}
                        sx={{
                            color: '#fff',
                            position: 'absolute', // Sale del flujo normal
                            right: 0,            // Se pega a la derecha del Box
                            top: '50%',          // Lo bajamos al 50%
                            transform: 'translateY(-50%)', // Lo centramos verticalmente exacto
                            '&:hover': {
                                color: '#ff1744',  // Un toque de color rojo al pasar el mouse opcional
                                bgcolor: 'rgba(255, 23, 68, 0.1)'
                            }
                        }}
                    >
                        <CloseIcon />
                    </IconButton>
                </Box>

                {/* Contenedor de Imagen */}
                <Box sx={{
                    position: 'relative',
                    width: '100%',
                    height: { xs: '150px', md: '350px' },
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    bgcolor: '#111',
                    borderRadius: 2,
                    overflow: 'hidden'
                }}>
                    {project.images.length > 1 && (
                        <>
                            <IconButton
                                onClick={handlePrev}
                                sx={{ position: 'absolute', left: 10, zIndex: 10, bgcolor: 'rgba(0,0,0,0.6)', color: '#00e5ff', '&:hover': { bgcolor: '#00e5ff', color: '#000' } }}
                            >
                                <ArrowBackIosNewIcon />
                            </IconButton>

                            <IconButton
                                onClick={handleNext}
                                sx={{ position: 'absolute', right: 10, zIndex: 10, bgcolor: 'rgba(0,0,0,0.6)', color: '#00e5ff', '&:hover': { bgcolor: '#00e5ff', color: '#000' } }}
                            >
                                <ArrowForwardIosIcon />
                            </IconButton>
                        </>
                    )}

                    <AnimatePresence mode="wait">
                        <motion.img
                            key={currentIndex}
                            src={getImagePath(project.images[currentIndex]?.src)}
                            initial={{ opacity: 0, x: 20 }}
                            animate={{ opacity: 1, x: 0 }}
                            exit={{ opacity: 0, x: -20 }}
                            transition={{ duration: 0.3 }}
                            style={{
                                maxWidth: '100%',
                                maxHeight: '100%',
                                objectFit: 'contain'
                            }}
                        />
                    </AnimatePresence>
                </Box>

                {/* Footer / Indicador */}
                <Box sx={{ mt: 2, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                    <Typography variant="caption"   sx={{ color: '#00bfa6', fontWeight: 'bold', textAlign: 'center' }}>
                      {project.images[currentIndex]?.caption || project.title}
                    </Typography>
                    <Typography variant="caption" sx={{ color: 'rgba(255,255,255,0.5)' }}>
                        Imagen {currentIndex + 1} de {project.images.length}
                    </Typography>
                </Box>
            </Box>
        </Dialog>
    );
};

export default ProjectGalleryModal;